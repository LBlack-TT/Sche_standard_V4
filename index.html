<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¼ä¸šç‰©æ–™åæŸ¥ & BOMæ¯”å¯¹ç³»ç»Ÿ (V3.4 å¼¹çª—æœåº“ç‰ˆ)</title>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/localforage/1.10.0/localforage.min.js"></script>
    
    <style>
        body { font-family: "Segoe UI", Roboto, Helvetica, Arial, sans-serif; max-width: 1200px; margin: 0 auto; padding: 20px; background-color: #f5f7fa; color: #333; }
        .container { background: white; padding: 0; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); overflow: hidden; min-height: 80vh;}
        
        /* é¡¶éƒ¨å¯¼èˆª Tab */
        .nav-tabs { display: flex; background: #f8f9fa; border-bottom: 1px solid #eee; }
        .nav-item { 
            flex: 1; text-align: center; padding: 20px; cursor: pointer; font-size: 16px; font-weight: bold; color: #7f8c8d; 
            transition: 0.3s; border-right: 1px solid #eee;
        }
        .nav-item:hover { background: #ecf0f1; }
        .nav-item.active { background: white; color: #3498db; border-top: 3px solid #3498db; }
        
        /* é¡µé¢å†…å®¹åŒº */
        .tab-content { display: none; padding: 30px; }
        .tab-content.active { display: block; }

        /* é€šç”¨ç»„ä»¶ */
        h1 { color: #2c3e50; padding-bottom: 10px; font-size: 22px; display: flex; justify-content: space-between; align-items: center; }
        .section { margin-bottom: 25px; border-bottom: 1px dashed #eee; padding-bottom: 20px; }
        .section:last-child { border-bottom: none; }
        label { display: block; font-weight: bold; margin-bottom: 10px; color: #2c3e50; }
        
        .upload-box { border: 2px dashed #3498db; background-color: #f0f8ff; padding: 25px; text-align: center; border-radius: 8px; cursor: pointer; transition: 0.3s; }
        .upload-box:hover { background-color: #e1f5fe; border-color: #2980b9; }
        input[type="file"] { display: none; }

        /* æ•°æ®åº“çŠ¶æ€ */
        .db-status { font-size: 13px; font-weight: normal; padding: 4px 10px; border-radius: 4px; background: #eee; color: #666; }
        .db-status.active { background: #e8f5e9; color: #2e7d32; border: 1px solid #c8e6c9; }

        /* æ–‡ä»¶åˆ—è¡¨ */
        .file-list { margin-top: 10px; display: flex; flex-wrap: wrap; gap: 8px; }
        .file-tag { background: #e3f2fd; color: #1976d2; padding: 5px 10px; border-radius: 15px; font-size: 12px; border: 1px solid #bbdefb; }
        
        /* è¾“å…¥æ¡†ä¸æŒ‰é’® */
        .input-group { display: flex; gap: 15px; margin-bottom: 15px; }
        .input-field { flex: 1; }
        
        input[type="text"] { 
            width: 100%; 
            padding: 10px; 
            border: 1px solid #ddd; 
            border-radius: 4px; 
            box-sizing: border-box; 
        }
        
        button { border: none; padding: 12px 25px; border-radius: 4px; cursor: pointer; font-size: 15px; transition: 0.3s; }
        .btn-primary { background-color: #3498db; color: white; width: 100%; }
        .btn-primary:hover { background-color: #2980b9; }
        .btn-primary:disabled { background-color: #bdc3c7; cursor: not-allowed; }
        .btn-secondary { background-color: #95a5a6; color: white; }
        .btn-danger { background-color: #ff6b6b; color: white; padding: 8px 15px; font-size: 13px; }

        /* è¡¨æ ¼é€šç”¨æ ·å¼ */
        table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 14px; table-layout: fixed; }
        th, td { border: 1px solid #eee; padding: 10px; text-align: left; word-break: break-all; }
        th { background-color: #f8f9fa; color: #2c3e50; font-weight: 600; }
        tr:nth-child(even) { background-color: #fcfcfc; }
        
        /* å¤åˆ¶äº¤äº’ */
        .copy-cell { cursor: pointer; position: relative; transition: 0.2s; }
        .copy-cell:hover { background-color: #e3f2fd !important; color: #1976d2; font-weight: bold; }
        .copy-cell:active { background-color: #bbdefb !important; }

        /* BOM æ¯”å¯¹ç»“æœä¸“ç”¨æ ·å¼ */
        .status-badge { padding: 4px 8px; border-radius: 4px; font-weight: bold; font-size: 12px; display: inline-block; text-align: center; width: 60px; }
        .status-ok { background: #d4edda; color: #155724; }
        .status-warn { background: #fff3cd; color: #856404; }
        .status-err { background: #f8d7da; color: #721c24; }

        .diff-text { color: #e74c3c; text-decoration: line-through; margin-right: 5px; font-size: 0.9em; }
        .correct-text { color: #27ae60; font-weight: bold; }

        .mode-selector { display: flex; gap: 20px; margin-bottom: 15px; padding: 10px; background: #f9f9f9; border-radius: 6px; border: 1px solid #eee; }
        .radio-label { display: flex; align-items: center; cursor: pointer; font-weight: normal; margin: 0; }
        .radio-label input { margin-right: 8px; transform: scale(1.2); }

        /* â˜…â˜…â˜… æ–°å¢ï¼šå¼¹çª—æ ·å¼ (Modal) â˜…â˜…â˜… */
        .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); }
        .modal-content { background-color: #fff; margin: 10% auto; padding: 25px; border-radius: 8px; width: 600px; max-width: 90%; box-shadow: 0 5px 15px rgba(0,0,0,0.3); animation: slideDown 0.3s; }
        @keyframes slideDown { from {transform: translateY(-50px); opacity: 0;} to {transform: translateY(0); opacity: 1;} }
        
        .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding-bottom: 15px; margin-bottom: 15px; }
        .modal-title { font-size: 18px; font-weight: bold; color: #2c3e50; }
        .close-btn { font-size: 24px; cursor: pointer; color: #aaa; }
        .close-btn:hover { color: #333; }
        
        /* å¼¹çª—å†…çš„æœç´¢ç»“æœ */
        .modal-results { max-height: 400px; overflow-y: auto; margin-top: 15px; border: 1px solid #eee; border-radius: 4px; }
        .modal-row { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #f5f5f5; font-size: 13px; }
        .modal-row:hover { background-color: #f9f9f9; }
        .modal-row:last-child { border-bottom: none; }
        .modal-info { flex: 1; }
        .modal-tag { display: inline-block; padding: 2px 6px; background: #eee; border-radius: 3px; font-size: 11px; margin-right: 5px; color: #555; }

        /* æç¤ºæ¡† */
        #toast { visibility: hidden; min-width: 200px; background-color: #333; color: #fff; text-align: center; border-radius: 4px; padding: 12px; position: fixed; z-index: 3000; left: 50%; bottom: 40px; transform: translateX(-50%); opacity: 0; transition: 0.3s; }
        #toast.show { visibility: visible; opacity: 1; bottom: 60px; }
    </style>
</head>
<body>

<div class="container">
    <div class="nav-tabs">
        <div class="nav-item active" onclick="switchTab('tab-search')">ğŸ” 1. ç³»ç»Ÿç‰©æ–™åæŸ¥</div>
        <div class="nav-item" onclick="switchTab('tab-bom')">ğŸ“‹ 2. BOM æ¯”å¯¹éªŒè¯</div>
    </div>

    <div id="tab-search" class="tab-content active">
        <h1>ç³»ç»Ÿåº“ç®¡ç† <span id="dbIndicator" class="db-status">è¿æ¥ä¸­...</span></h1>
        
        <div class="section">
            <label>1. ä¸Šä¼  Excel/CSV ç³»ç»Ÿè¡¨ (æ”¯æŒå¤šé€‰/è¿½åŠ )</label>
            <div class="upload-box" onclick="document.getElementById('sysFileInput').click()">
                <div style="font-size:24px">ğŸ“‚</div>
                <span>ç‚¹å‡»ä¸Šä¼ ç³»ç»Ÿä»£ç è¡¨</span>
                <input type="file" id="sysFileInput" multiple accept=".xls,.xlsx,.csv" onchange="handleSysFiles(this.files)">
            </div>
            <div id="fileListArea" class="file-list"></div>
            <div style="margin-top:10px; display:flex; justify-content:space-between;">
                <span id="sysStatus" style="color:#666; font-size:13px">ç­‰å¾…æ“ä½œ...</span>
                <button class="btn-danger" onclick="clearDatabase()">ğŸ—‘ï¸ æ¸…ç©ºåº“</button>
            </div>
        </div>

        <div class="section">
            <label>2. è¾“å…¥æŸ¥è¯¢æ¡ä»¶ (æ”¯æŒä»»æ„ç»„åˆ)</label>
            <div class="input-group">
                <div class="input-field"><input type="text" id="pnInput" placeholder="è¾“å…¥å“å· (å¦‚ 30101)"></div>
                <div class="input-field"><input type="text" id="nameInput" placeholder="è¾“å…¥å“å (å¦‚ ç”µé˜»)"></div>
                <div class="input-field"><input type="text" id="specInput" placeholder="è¾“å…¥è§„æ ¼ (å¦‚ 10k)"></div>
            </div>
            <div style="display:flex; gap:10px">
                <button class="btn-primary" id="searchBtn" onclick="searchData()" disabled>æŸ¥è¯¢</button>
                <button class="btn-secondary" onclick="clearSearchInputs()" style="flex:0.3">æ¸…ç©º</button>
            </div>
        </div>
        
        <div id="searchResultArea"></div>
    </div>

    <div id="tab-bom" class="tab-content">
        <h1>BOM æ¯”å¯¹éªŒè¯</h1>
        <div class="section">
            <label>ç¬¬ä¸€æ­¥ï¼šé€‰æ‹©æ¯”å¯¹ä¾æ®</label>
            <div class="mode-selector">
                <label class="radio-label">
                    <input type="radio" name="matchMode" value="pn" checked> æŒ‰å“å·åŒ¹é… (é»˜è®¤)
                    <span style="font-size:12px; color:#888; margin-left:5px;">- éªŒè¯è§„æ ¼æ˜¯å¦æ­£ç¡®</span>
                </label>
                <label class="radio-label">
                    <input type="radio" name="matchMode" value="spec"> æŒ‰è§„æ ¼åŒ¹é…
                    <span style="font-size:12px; color:#888; margin-left:5px;">- åæŸ¥å“å·æ˜¯å¦æ­£ç¡®</span>
                </label>
            </div>

            <label>ç¬¬äºŒæ­¥ï¼šä¸Šä¼  BOM è¡¨</label>
            <div class="upload-box" style="border-color: #27ae60; background: #f0fff4;" onclick="document.getElementById('bomFileInput').click()">
                <div style="font-size:24px">ğŸ“‘</div>
                <span>ç‚¹å‡»ä¸Šä¼  BOM è¡¨ (Excel/CSV)</span>
                <div style="font-size:12px; color:#666; margin-top:5px">å¿…é¡»åŒ…å«åˆ—å¤´ï¼šDesignatorã€å“å·ã€å“åã€è§„æ ¼å‹å·</div>
                <input type="file" id="bomFileInput" accept=".xls,.xlsx,.csv" onchange="handleBOMFile(this.files[0])">
            </div>
        </div>
        
        <div id="bomResultArea"></div>
    </div>
</div>

<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <span class="modal-title">ğŸ” è¾…åŠ©æœåº“åŠ©æ‰‹</span>
            <span class="close-btn" onclick="closeModal()">Ã—</span>
        </div>
        
        <div style="margin-bottom: 10px; color: #666; font-size: 13px;">è¯·ä¿®æ”¹å…³é”®è¯ (ç©ºæ ¼åˆ†éš”) ä»¥åœ¨ç³»ç»Ÿåº“ä¸­æœç´¢ï¼š</div>
        
        <div style="display: flex; gap: 10px;">
            <input type="text" id="modalInput" style="flex:1; padding:10px;" placeholder="è¾“å…¥è§„æ ¼æˆ–å“å·...">
            <button class="btn-primary" onclick="runModalSearch()" style="width: 80px;">æœç´¢</button>
        </div>
        
        <div id="modalResultArea" class="modal-results">
            <div style="padding:20px; text-align:center; color:#999;">è¯·è¾“å…¥å…³é”®è¯æœç´¢...</div>
        </div>
    </div>
</div>

<div id="toast">å·²å¤åˆ¶</div>

<script>
    // --- å…¨å±€é…ç½® ---
    const DB_KEY = 'mat_db_v3';
    const FILES_KEY = 'mat_files_v3';
    let globalDB = []; // ç³»ç»Ÿåº“æ•°æ®
    let loadedFiles = []; // å·²åŠ è½½æ–‡ä»¶åˆ—è¡¨

    // åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', async () => {
        await loadCache();
        
        // ç»‘å®šå¼¹çª—å›è½¦æœç´¢
        document.getElementById('modalInput').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') runModalSearch();
        });
        
        // ç‚¹å‡»å¼¹çª—å¤–éƒ¨å…³é—­
        window.onclick = function(event) {
            const modal = document.getElementById('searchModal');
            if (event.target == modal) closeModal();
        }
    });

    // åˆ‡æ¢ Tab
    window.switchTab = function(tabId) {
        document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        document.getElementById(tabId).classList.add('active');
        event.currentTarget.classList.add('active');
    }

    // ==========================================
    // æ¨¡å— 1: ç³»ç»Ÿåº“ç®¡ç†
    // ==========================================
    async function loadCache() {
        try {
            const db = await localforage.getItem(DB_KEY);
            const files = await localforage.getItem(FILES_KEY);
            if (db && db.length) {
                globalDB = db;
                loadedFiles = files || [];
                updateSysUI(true, `å·²åŠ è½½ ${globalDB.length} æ¡ç³»ç»Ÿæ•°æ®`);
                renderFileList();
            } else {
                updateSysUI(false, "åº“ä¸ºç©º");
            }
        } catch (e) { console.error(e); }
    }

    async function handleSysFiles(files) {
        if (!files.length) return;
        setSysStatus(`æ­£åœ¨è§£æ ${files.length} ä¸ªæ–‡ä»¶...`, 'orange');
        const promises = Array.from(files).map(readSysFile);
        try {
            await Promise.all(promises);
            const map = new Map();
            globalDB.forEach(i => map.set(i.pn, i));
            globalDB = Array.from(map.values());
            await localforage.setItem(DB_KEY, globalDB);
            await localforage.setItem(FILES_KEY, loadedFiles);
            updateSysUI(true, `æ›´æ–°æˆåŠŸï¼å½“å‰åº“å…± ${globalDB.length} æ¡`);
            renderFileList();
        } catch (e) { setSysStatus("è§£æå¤±è´¥", 'red'); }
    }

    function readSysFile(file) {
        return new Promise((resolve) => {
            const reader = new FileReader();
            reader.onload = (e) => {
                const wb = XLSX.read(e.target.result, {type:'array'});
                let count = 0;
                wb.SheetNames.forEach(name => {
                    const rows = XLSX.utils.sheet_to_json(wb.Sheets[name], {header:1});
                    const items = scanBlockData(file.name, rows);
                    globalDB.push(...items);
                    count += items.length;
                });
                loadedFiles = loadedFiles.filter(f => f.name !== file.name);
                loadedFiles.push({ name: file.name, count: count });
                resolve();
            };
            reader.readAsArrayBuffer(file);
        });
    }

    function scanBlockData(fileName, rows) {
        let res = [], currPN = null, currName = "";
        rows.forEach(row => {
            row.forEach((cell, idx) => {
                if(!cell) return;
                let val = String(cell).replace(/\s/g,"");
                if(val.includes("å“å·") && (val.includes(":")||val.includes("ï¼š"))) {
                    if(idx+1 < row.length) {
                        let pn = String(row[idx+1]).trim();
                        if(pn && !pn.includes("~")) { currPN = pn; currName = ""; }
                    }
                }
                if(currPN && val.includes("å“å") && (val.includes(":")||val.includes("ï¼š"))) {
                    if(idx+1 < row.length) currName = String(row[idx+1]).trim();
                }
                if(currPN && val.includes("è§„æ ¼") && (val.includes(":")||val.includes("ï¼š"))) {
                    if(idx+1 < row.length) {
                        res.push({ file:fileName, pn:currPN, name:currName, spec:String(row[idx+1]).trim() });
                    }
                }
            });
        });
        return res;
    }

    // ==========================================
    // æ¨¡å— 2: BOM æ¯”å¯¹
    // ==========================================
    function handleBOMFile(file) {
        if (!file) return;
        if (globalDB.length === 0) { alert("è¯·å…ˆä¸Šä¼ ç³»ç»Ÿä»£ç è¡¨"); return; }
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const wb = XLSX.read(e.target.result, {type:'array'});
                const ws = wb.Sheets[wb.SheetNames[0]];
                const bomData = XLSX.utils.sheet_to_json(ws); 
                renderBOMReport(bomData);
            } catch (err) { alert("BOM è§£æå¤±è´¥"); }
        };
        reader.readAsArrayBuffer(file);
    }

    function renderBOMReport(bomData) {
        const div = document.getElementById('bomResultArea');
        if (!bomData.length) { div.innerHTML = "<p>BOM æ–‡ä»¶ä¸ºç©º</p>"; return; }

        const matchMode = document.querySelector('input[name="matchMode"]:checked').value;
        const isModeSpec = (matchMode === 'spec');
        let col3Title = isModeSpec ? "å“å·æ¯”å¯¹ (ä¸Š:BOM / ä¸‹:ç³»ç»Ÿ)" : "è§„æ ¼æ¯”å¯¹ (ä¸Š:BOM / ä¸‹:ç³»ç»Ÿ)";

        let html = `<h3>æ¯”å¯¹ç»“æœ (${bomData.length} è¡Œ) - å½“å‰æ¨¡å¼: ${isModeSpec?'æŒ‰è§„æ ¼':'æŒ‰å“å·'}</h3>`;
        html += `<table><thead><tr>
            <th style="width:12%">ä½å·</th>
            <th style="width:15%">BOM å“å·</th>
            <th style="width:8%">çŠ¶æ€</th>
            <th style="width:30%">${col3Title}</th>
            <th style="width:20%">å“å/è§„æ ¼</th>
            <th style="width:15%">æ“ä½œ</th>
        </tr></thead><tbody>`;

        let okCount=0, warnCount=0, errCount=0;

        bomData.forEach(row => {
            const bomPN = String(row['å“å·'] || row['Part Number'] || "").trim();
            const bomSpec = String(row['è§„æ ¼å‹å·'] || row['è§„æ ¼'] || row['Specification'] || "").trim();
            const bomName = String(row['å“å'] || row['Description'] || "").trim();
            const bomDesig = String(row['Designator'] || row['RefDes'] || "").trim();

            if (!bomPN && !bomSpec) return;

            let sysItem = null;
            if (isModeSpec) {
                const cleanBomSpec = bomSpec.replace(/\s/g, "");
                if (cleanBomSpec) sysItem = globalDB.find(i => i.spec.replace(/\s/g, "") === cleanBomSpec);
            } else {
                if (bomPN) sysItem = globalDB.find(i => i.pn === bomPN);
            }

            let statusHtml = "", diffHtml = "", infoHtml = bomName;
            
            if (!sysItem) {
                statusHtml = `<span class="status-badge status-err">æœªæ‰¾åˆ°</span>`;
                diffHtml = `<span style="color:#999">ç³»ç»Ÿåº“æ— æ­¤${isModeSpec ? 'è§„æ ¼' : 'å“å·'}</span>`;
                infoHtml += `<br><span style="color:#999;font-size:12px">${bomSpec}</span>`;
                errCount++;
            } else {
                if (isModeSpec) {
                    infoHtml += `<br><span style="color:#27ae60;font-size:12px">âœ” ${bomSpec}</span>`;
                    if (sysItem.pn === bomPN) {
                        statusHtml = `<span class="status-badge status-ok">åŒ¹é…</span>`;
                        diffHtml = `<span style="color:#27ae60">âœ” ${bomPN}</span>`;
                        okCount++;
                    } else {
                        statusHtml = `<span class="status-badge status-warn">ä¸ç¬¦</span>`;
                        diffHtml = `<div class="diff-text">${bomPN||"(ç©º)"}</div><div class="correct-text">${sysItem.pn}</div>`;
                        warnCount++;
                    }
                } else {
                    infoHtml = bomName;
                    const cleanBomSpec = bomSpec.replace(/\s/g, "");
                    const cleanSysSpec = sysItem.spec.replace(/\s/g, "");
                    if (cleanBomSpec === cleanSysSpec) {
                        statusHtml = `<span class="status-badge status-ok">åŒ¹é…</span>`;
                        diffHtml = `<span style="color:#27ae60">âœ” ${bomSpec}</span>`;
                        okCount++;
                    } else {
                        statusHtml = `<span class="status-badge status-warn">ä¸ç¬¦</span>`;
                        diffHtml = `<div class="diff-text">${bomSpec}</div><div class="correct-text">${sysItem.spec}</div>`;
                        warnCount++;
                    }
                }
            }

            // â˜…â˜…â˜… æ“ä½œæ ï¼šå¢åŠ æœç´¢æŒ‰é’® â˜…â˜…â˜…
            // å¯¹æœªæ‰¾åˆ°æˆ–ä¸ç¬¦çš„é¡¹ï¼Œæä¾›æœç´¢åŠŸèƒ½
            let actions = ``;
            
            // æœç´¢æŒ‰é’® (ä¼ å…¥è§„æ ¼ä½œä¸ºåˆå§‹å…³é”®è¯)
            const searchKeyword = bomSpec.replace(/"/g, "&quot;"); // ç®€å•çš„è½¬ä¹‰
            actions += `<button onclick="openSearchModal('${encodeURIComponent(searchKeyword)}')" class="btn-primary" style="padding:4px 8px; font-size:12px; width:auto; margin-right:5px; background-color:#3498db;">ğŸ” æ‰¾</button>`;
            
            // å¤åˆ¶æ­£ç¡®å€¼æŒ‰é’®
            if (sysItem) {
                const copyVal = isModeSpec ? sysItem.pn : sysItem.spec;
                const copyLabel = isModeSpec ? 'å“å·' : 'è§„æ ¼';
                actions += `<button onclick="copyTextStr('${copyVal}')" class="btn-secondary" style="padding:4px 8px; font-size:12px; width:auto;">å¤åˆ¶${copyLabel}</button>`;
            }

            html += `<tr>
                <td class="copy-cell" onclick="copyText(this)">${bomDesig}</td>
                <td class="copy-cell" onclick="copyText(this)">${bomPN}</td>
                <td>${statusHtml}</td>
                <td>${diffHtml}</td>
                <td>${infoHtml}</td>
                <td>${actions}</td>
            </tr>`;
        });

        html += `</tbody></table>`;
        const summary = `<div style="margin-bottom:15px; padding:10px; background:#fff; border:1px solid #eee; display:flex; gap:20px;">
            <span style="color:#155724">âœ… å®Œå…¨åŒ¹é…: <strong>${okCount}</strong></span>
            <span style="color:#856404">âš ï¸ å·®å¼‚/å»ºè®®: <strong>${warnCount}</strong></span>
            <span style="color:#721c24">âŒ æœªæ‰¾åˆ°: <strong>${errCount}</strong></span>
        </div>`;
        div.innerHTML = summary + html;
    }

    // ==========================================
    // æ¨¡å— 3: å¼¹çª—æœåº“ (Modal Logic)
    // ==========================================
    function openSearchModal(encodedKeyword) {
        const keyword = decodeURIComponent(encodedKeyword);
        document.getElementById('modalInput').value = keyword;
        document.getElementById('searchModal').style.display = "block";
        document.getElementById('modalInput').focus();
        // è‡ªåŠ¨è§¦å‘ä¸€æ¬¡æœç´¢ï¼ˆå¯é€‰ï¼Œå¦‚æœå…³é”®è¯å¤ªé•¿å¯èƒ½æœä¸åˆ°ï¼Œç”¨æˆ·å¯ä»¥ä¿®æ”¹åå›è½¦ï¼‰
        runModalSearch(); 
    }

    function closeModal() {
        document.getElementById('searchModal').style.display = "none";
    }

    function runModalSearch() {
        const rawInput = document.getElementById('modalInput').value.toLowerCase().trim();
        const container = document.getElementById('modalResultArea');
        
        if (!rawInput) { container.innerHTML = ""; return; }
        
        // æ”¯æŒç©ºæ ¼åˆ†éš”çš„å¤šå…³é”®è¯ (AND é€»è¾‘)
        const keywords = rawInput.split(/\s+/);
        
        const results = globalDB.filter(item => {
            const fullStr = (item.pn + " " + item.spec + " " + item.name).toLowerCase();
            // æ£€æŸ¥æ˜¯å¦åŒ…å«æ‰€æœ‰å…³é”®è¯
            return keywords.every(kw => fullStr.includes(kw));
        }); // é™åˆ¶æ˜¾ç¤ºå‰ 50 æ¡é˜²æ­¢å¡é¡¿

        if (results.length === 0) {
            container.innerHTML = `<div style="padding:20px; text-align:center; color:red;">æœªæ‰¾åˆ°åŒ¹é…é¡¹ï¼Œè¯·ç²¾ç®€å…³é”®è¯é‡è¯•</div>`;
            return;
        }

        let html = "";
        results.slice(0, 100).forEach(item => {
            html += `
            <div class="modal-row">
                <div class="modal-info">
                    <div><span class="modal-tag">å“å·</span> <strong style="color:#333">${item.pn}</strong></div>
                    <div style="margin-top:4px;"><span class="modal-tag">è§„æ ¼</span> ${item.spec}</div>
                    <div style="color:#888; margin-top:2px; font-size:12px;">${item.name}</div>
                </div>
                <div>
                    <button class="btn-primary" onclick="copyTextStr('${item.pn}')" style="padding:4px 8px; font-size:12px; width:auto;">å¤åˆ¶å“å·</button>
                    <button class="btn-secondary" onclick="copyTextStr('${item.spec}')" style="padding:4px 8px; font-size:12px; width:auto; margin-top:5px;">å¤åˆ¶è§„æ ¼</button>
                </div>
            </div>`;
        });
        
        container.innerHTML = `
            <div style="padding:5px 10px; background:#e8f5e9; color:#2e7d32; font-size:12px;">æ‰¾åˆ° ${results.length} æ¡ç»“æœ (æ˜¾ç¤ºå‰ 100 æ¡)</div>
            ${html}
        `;
    }


    // ==========================================
    // æ¨¡å— 4: é€šç”¨ UI ä¸å¤åˆ¶
    // ==========================================
    function updateSysUI(active, text) {
        const ind = document.getElementById('dbIndicator');
        const stat = document.getElementById('sysStatus');
        const btn = document.getElementById('searchBtn');
        ind.innerText = active ? "ğŸŸ¢ å·²è¿æ¥" : "âšª æœªè¿æ¥";
        ind.className = active ? "db-status active" : "db-status";
        stat.innerText = text;
        stat.style.color = active ? "green" : "#666";
        btn.disabled = !active;
    }

    function setSysStatus(msg, color) { document.getElementById('sysStatus').innerText = msg; document.getElementById('sysStatus').style.color = color; }
    
    function renderFileList() {
        const div = document.getElementById('fileListArea');
        div.innerHTML = "";
        loadedFiles.forEach(f => {
            const tag = document.createElement('div');
            tag.className = 'file-tag'; tag.innerText = `${f.name} (${f.count})`;
            div.appendChild(tag);
        });
    }

    async function clearDatabase() {
        if(confirm("ç¡®å®šæ¸…ç©ºç³»ç»Ÿåº“ï¼Ÿ")) {
            await localforage.clear();
            globalDB=[]; loadedFiles=[];
            updateSysUI(false, "å·²æ¸…ç©º"); renderFileList();
            document.getElementById('searchResultArea').innerHTML="";
        }
    }

    function searchData() {
        const qPN = document.getElementById('pnInput').value.toLowerCase().trim();
        const qName = document.getElementById('nameInput').value.toLowerCase().trim();
        const qSpec = document.getElementById('specInput').value.toLowerCase().trim();
        if(!qPN && !qName && !qSpec) { alert("è¯·è¾“å…¥æ¡ä»¶"); return; }
        const res = globalDB.filter(i => {
            const mPN = qPN ? String(i.pn).toLowerCase().includes(qPN) : true;
            const mName = qName ? String(i.name).toLowerCase().includes(qName) : true;
            const mSpec = qSpec ? String(i.spec).toLowerCase().includes(qSpec) : true;
            return mPN && mName && mSpec;
        });
        renderTable(res, 'searchResultArea');
    }

    function renderTable(data, containerId) {
        const div = document.getElementById(containerId);
        if(!data.length) { div.innerHTML="<p style='color:red;text-align:center'>æœªæ‰¾åˆ°è®°å½•</p>"; return; }
        let h = `<table><thead><tr><th>å“å·</th><th>å“å</th><th>è§„æ ¼</th><th>æ¥æº</th></tr></thead><tbody>`;
        data.forEach(i => {
            h += `<tr><td class="copy-cell" onclick="copyText(this)">${i.pn}</td><td class="copy-cell" onclick="copyText(this)">${i.name}</td><td class="copy-cell" onclick="copyText(this)">${i.spec}</td><td>${i.file}</td></tr>`;
        });
        h+="</tbody></table>";
        div.innerHTML = `<h3>æ‰¾åˆ° ${data.length} æ¡è®°å½•</h3>` + h;
    }

    function clearSearchInputs() {
        ['pnInput','nameInput','specInput'].forEach(id=>document.getElementById(id).value='');
        document.getElementById('searchResultArea').innerHTML="";
    }

    window.copyText = function(el) { execCopy(el.innerText); }
    window.copyTextStr = function(str) { execCopy(str); }

    function execCopy(text) {
        if(!text) return;
        const ta = document.createElement("textarea");
        ta.value = text; ta.style.position="fixed"; ta.style.left="-9999px";
        document.body.appendChild(ta); ta.select();
        try { document.execCommand('copy'); showToast("å·²å¤åˆ¶: "+text); } catch(e) { alert("å¤åˆ¶å¤±è´¥"); }
        document.body.removeChild(ta);
    }

    function showToast(msg) {
        const t = document.getElementById("toast");
        t.innerText = msg; t.classList.add("show");
        setTimeout(()=>t.classList.remove("show"), 2000);
    }
</script>

</body>
</html>
